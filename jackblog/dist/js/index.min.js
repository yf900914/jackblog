angular.module('app.routes',['ui.router']).config(["$stateProvider", "$httpProvider", function($stateProvider,$httpProvider){
    $httpProvider.defaults.headers.common["X-Requested-With"]='XMLHttpRequest';
    return $stateProvider.state('search',{
        url:'/search',
        template:'<topic-list></topic-list>',
        controller:'listController'
    }).state('detail',{
        url:'/detail/:id',
        template:'<topic-detail></topic-detail>',
        contoller:'detailController'
    });
}]);

var app=angular.module('app',['ui.router','app.routes',
'app.common.factory',
'common.netService',
 'app.common.factory',
'app.topiclist.controller']);
app.run(["netService", "$rootScope", function(netService,$rootScope){
    $rootScope.title="Jackblog"
}])  
angular.module('common.netService', [])
    .constant("config",{
        host:"https://cnodejs.org"
    })
    .constant("apiUrl", {
        getTopic: '/api/v1/topics?callback=JSON_CALLBACK/get',
        searchTopic: '/api/v1/topics?callback=JSON_CALLBACK/search',
        addTopic: '/topic/add',
        deleteTopic: '/topic/delete'
    })
    .service('netService', ["$http", "apiUrl", "config", function ($http, apiUrl,config) {
    var $this, fn, url;
    $this = this;
    fn = function (url) {
        return $this[url] = function (method, data) {
            var opts;
            if (method.toLowerCase() === 'get' || method === 'delete') {
                opts = {
                    method: method,
                    url: config.host+apiUrl[url],
                    params: data
                };
            } else if(method.toLowerCase()=='post'){
                opts = {
                    method: method,
                    url: config.host+apiUrl[url],
                    data: data
                };
            } else {
                opts ={
                    method:jsonp,
                    url:config.host+apiUrl[url],
                    params:{callback:'JSON_CALLBACK'}
                }
            }
            return $http(opts);
        };
    };
    for (url in apiUrl) {
        fn(url);
    }
}]);
angular.module('app.common.factory', []).factory('transferData', function () {
    var get, localStorage, set;
    localStorage = window.localStorage;
    set = function (key, data) {
        return localStorage[key] = JSON.stringify(data);
    };
    get = function (key) {
        if (localStorage[key]) {
            return JSON.parse(localStorage[key]);
        } else {
            return null;
        }
    };
    return {
        set: set,
        get: get
};
});


angular.module('app.topiclist.directive.topiclist',['app.topiclist.directive.topicitem'])
.directive('topicList',function(){
    return{
        restric:'EA',
        template:'<div class="topiclist"><topic item="item" ng-repeat="item in topiclist"></topic></div>'
    }
})
angular.module('app.topiclist.directive.topicitem',['app.topiclist.directive.topic']).directive('topicItem',function(){
    return {
        restric:'EA',
        template:'<section class="topicitem"><topic-item></topic-item></section>'
    }
})
angular.module('app.topiclist.directive.topic',[]).directive('topic',function(){
    return {
        restric:'EA',
        template:'<div class="topic-con">'+
        '<p class="list-top"><span class="creattime">{{item.create_at}}</span></p>'+
        '<h4 class="title"><a ui-sref="detail({id:item.id})" class="link-title">{{item.title}}</a></h4>'+
        '<div class="list-footer"><span>阅读 {{item.visit_count}}</span><span>评论 {{item.reply_count}}</span></div>'+
        '</div>'
    }
})
angular.module('app.topicdetail.controler',['app.topicdetail.directive.topicdetail'])
.controller('detailController',["$scope", "$stateParams", "netService", function($scope, $stateParams, netService){
     $scope.id=$stateParams.id;
      netService.getTopic('get',{
          id:$scope.id
    }).success(function(body){
        var data;
        if (body.success!==true){
            console.error("netService.addTask",body);
        }
        data=body.data;
        console.log(data);
    })

}])
angular.module('app.topiclist.controller',['app.topiclist.directive.topiclist'])
.controller('listController',["$scope", "netService", function($scope,netService){
    netService.searchTopic('get',{
        limit:10
    }).success(function(body){
        var data;
        if(body.success!==true){
            console.error("netService.addTask",body);
        }
        data = body.data;
        console.log(data);
        return $scope.topiclist = data;
    });
}])